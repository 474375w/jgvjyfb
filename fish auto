local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local CONFIG = {
    CAST_POWER = 100,
    REEL_ATTEMPTS = 256,
    RETRY_DELAY = 1,
}

local initialPosition
local connections = {}
local lastCastTime = 0
local isFishing = false
local hasBite = false

local function cleanupConnections()
    for _, connection in pairs(connections) do
        if connection then
            connection:Disconnect()
        end
    end
    table.clear(connections)
end

local function fireReelFinished()
    for _ = 1, CONFIG.REEL_ATTEMPTS do
        task.spawn(function()
            ReplicatedStorage.events.reelfinished:FireServer(1000, true)
        end)
    end
end

local function getNearestWaterPoint()
    local character = Players.LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local nearestPoint
    local shortestDistance = math.huge
    
    for _, part in pairs(workspace.zones.fishing:GetChildren()) do
        local distance = (part.Position - humanoidRootPart.Position).Magnitude
        if distance < shortestDistance then
            shortestDistance = distance
            nearestPoint = part.Position
        end
    end
    
    return nearestPoint
end

local function faceWater()
    local character = Players.LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local waterPoint = getNearestWaterPoint()
    if not waterPoint then return end
    
    if not initialPosition then
        initialPosition = humanoidRootPart.Position
    end
    
    local lookVector = (waterPoint - humanoidRootPart.Position).Unit
    humanoidRootPart.CFrame = CFrame.new(
        initialPosition,
        initialPosition + Vector3.new(lookVector.X, 0, lookVector.Z)
    )
end

local function getFishingRod()
    local character = Players.LocalPlayer.Character
    if not character then return end
    
    for _, tool in pairs(character:GetChildren()) do
        if tool:FindFirstChild("events") and tool:FindFirstChild("events"):FindFirstChild("cast") then
            return tool
        end
    end
end

local function castRod()
    local rod = getFishingRod()
    if rod and tick() - lastCastTime > CONFIG.RETRY_DELAY then
        lastCastTime = tick()
        rod.events.cast:FireServer(CONFIG.CAST_POWER)
        return true
    end
    return false
end

local function setupBobberListener()
    local rod = getFishingRod()
    if not rod then return end
    
    local bobberConnection = rod.ChildAdded:Connect(function(child)
        if child.Name == "bobber" then
            isFishing = true
            hasBite = false
        end
    end)
    
    local bobberRemoveConnection = rod.ChildRemoved:Connect(function(child)
        if child.Name == "bobber" then
            if isFishing and not hasBite then
                task.wait(CONFIG.RETRY_DELAY)
                faceWater()
                castRod()
            end
            isFishing = false
        end
    end)
    
    table.insert(connections, bobberConnection)
    table.insert(connections, bobberRemoveConnection)
end

local function setupSoundListener()
    local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
    
    local soundConnection = playerGui.DescendantAdded:Connect(function(descendant)
        if descendant:IsA("Sound") and descendant.Name == "popup" then
            hasBite = true
            fireReelFinished()
            
            local ancestryConnection
            ancestryConnection = descendant.AncestryChanged:Connect(function(_, parent)
                if not parent then
                    fireReelFinished()
                    task.wait(CONFIG.RETRY_DELAY)
                    if getFishingRod() then
                        faceWater()
                        castRod()
                    end
                    ancestryConnection:Disconnect()
                end
            end)
        end
    end)
    
    table.insert(connections, soundConnection)
end

local function onHeartbeat()
    local character = Players.LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local rod = getFishingRod()
    
    if not rod then
        initialPosition = nil
        isFishing = false
        hasBite = false
        return
    end
    
    if not initialPosition then
        initialPosition = humanoidRootPart.Position
        faceWater()
        task.wait(0.5)
        castRod()
    else
        local currentLook = humanoidRootPart.CFrame.LookVector
        humanoidRootPart.CFrame = CFrame.new(
            initialPosition,
            initialPosition + currentLook
        )
    end
end

do
    cleanupConnections()
    
    setupSoundListener()
    setupBobberListener()
    
    local heartbeat = RunService.Heartbeat:Connect(onHeartbeat)
    table.insert(connections, heartbeat)
end
